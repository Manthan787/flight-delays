---
title: "A8: Visualizing Flight Delays"
author: "Manthan Thakar"
date: "November 7, 2017"
geometry: "left=1cm,right=1cm,top=1cm,bottom=1cm"
output: pdf_document
---

```{r echo=FALSE}
#install.packages("tidyr")
#install.packages("igraph")
```

```{r message=FALSE, echo=FALSE}
library(tidyr)
library(ggplot2)
library(maps)
library(dplyr)
library(pander)
library(igraph)
library(RColorBrewer) 
library(gridExtra)
RESOURCE_DIR = "resources/"
#knitr::opts_chunk$set(dev = 'pdf')
#knitr::opts_chunk$set(error = TRUE)
```

## Objective

Visualize the mean delay of the five most active airlines and for the five most active airports in the country from given historical data.

## Data Processing

In order to obtain delay data for airports and airline, we first gather the data by discarding invalid records. We run a **single** MapReduce job for that purpose.

**Mapper**: The map phase of the mapreduce job is responsible for 
    - Validating each record by performing sanity checks
    - Emitting valid records with `airline`, `airport`, `year` and `month` as a key and `delay` as value

**Reducer**: In the reduce phase all the same flights are aggregated and we calculate the mean delay for each flight. To reduce the shuffling of data over the network, we use the same reducer as **combiner** as well. 

Since, there could be many similar flights in the same month of the same year, using combiner in our design significantly reduces the amount of data that is shuffled for the reduce phase.

### Performance

#### AWS Cluster Configurations

The Amazon Map Reduce cluster was setup using Amazon EMR.

```{r echo=FALSE, message=FALSE}
x = c("Instance Type", "Hadoop Distribution", "Memory", "Storage", "vCPU", "No. Nodes")
y = c("m3.xlarge", "Amazon 2.7.3 (EMR 5.8.0)", "15GB", "2 x 40GB SSD", "4", "4")
df = data.frame(config=x, value=y)
#pandoc.table(df, style="rmarkdown")
```

|       config        |          value           |
|:-------------------:|:------------------------:|
|    Instance Type    |        m3.xlarge         |
| Hadoop Distribution | Amazon 2.7.3 (EMR 5.8.0) |
|       Memory        |           15GB           |
|       Storage       |       2 x 40GB SSD       |
|        vCPU         |            4             |
|      No. Nodes      |            4             |


On a 4-node m3.xlarge cluster, it takes about **13 minutes** to run our job. Note that this is a noticable improvement over previous submission where it took **19 minutes** to run jobs. This is because 3 mapreduce jobs were employed in that approach.

### Most Active Airports and Airlines

The following graphs show the top 5 most active airlines and airports extracted from the data.

```{r cache=TRUE, echo=FALSE, message=FALSE}
read_files = function(dirname, col_names=c()) {
  files <- dir(paste("resources/", dirname, sep=""), recursive=TRUE, full.names=TRUE)
  tables <- lapply(files, read.csv)
  tables <- lapply(tables, setNames, nm = col_names)
  do.call(rbind, tables)
}
col_names <- c("airlineID", "airportID", "month", "year", "mDelay")
delays = read_files("new-delays", col_names)
```

```{r echo=FALSE}
airline_counts = count(delays, vars = delays$airlineID)
airport_counts = count(delays,  vars = delays$airportID)
top_5_airlines = airline_counts[(order(-airline_counts$n)), ][1:5, ]
top_5_airports = airport_counts[(order(-airport_counts$n)), ][1:5, ]
names(top_5_airlines) = c("airline", "activity")
names(top_5_airports) = c("airport", "activity")
```

```{r eval=FALSE, echo=FALSE}
data2 = read.csv("resources/dest_to_full_name.csv", header=T)
coords = read.csv("resources/coordinates.csv", header=T)
names(coords) = c("airport", "Latitude", "Longitude")
airports_with_coords = merge(top_5_airports, coords)
x = map("state", col="grey20",  border="gray3", fill=TRUE, bg="gray40")
for (i in (1:nrow(top_5_airports))) { 
points(-airports_with_coords$Longitude[i],airports_with_coords$Latitude[i], pch=19, cex=(0.8*(5/5))*((5+1)-i),col="chocolate1")
}
```


```{r echo=FALSE, message=FALSE, fig.width=12}
airport_lookup = read.csv(paste(RESOURCE_DIR, "dest_to_full_name.csv", sep=""), header=T)
names(airport_lookup) = c("airport", "full")
top_5_airports = merge(top_5_airports, airport_lookup)[1:5, ]
top_5_airports.plot = ggplot(top_5_airports, aes(x=airport, y=activity, color=full)) + geom_bar(stat="identity", fill="white") + labs(colour = "Airports", y= "No. of Flights", x="Airport Code",title = "Top 5 Airports") 
airline_lookup = read.csv(paste(RESOURCE_DIR, "airline_lookup.csv", sep=""), header=T)
names(airline_lookup) = c("airline", "full")
top_5_airlines = merge(top_5_airlines, airline_lookup)[1:5, ]
top_5_airlines.plot = ggplot(top_5_airlines, aes(x=airline, y=activity, color=full)) +
  labs(colour = "Airlines",y= "No. of Flights",x="Airline Code",title = "Top 5 Airlines") +
  geom_bar(stat="identity", fill="white")
grid.arrange(top_5_airlines.plot, top_5_airports.plot, ncol=2, widths= c(6, 6))
```

## Delays

```{r fig.width=12,fig.height=3,fig.show='hold',fig.align='center', echo=FALSE}
# Let's try some visualizations.

# get data for top 5 airports first
top_airports = delays[((delays$airportID %in% top_5_airports$airport) & !(delays$airlineID %in% c("RU"))), ]
agg = aggregate(mDelay ~ airlineID + airportID, data=top_airports, FUN=mean)

hm.palette <- colorRampPalette(rev(brewer.pal(9, 'Spectral')), space='Lab') 
ggplot(agg, aes(y=airportID, x=airlineID)) + geom_tile(aes(fill=mDelay), color="white") + scale_fill_gradientn(colours = hm.palette(1000)) + labs(x = "Airlines",y="Airport",col = "Delay in Minutes", title="Fig 1. Mean delays from all airlines to top 5 airports across all years") + theme_light() + coord_fixed(ratio = 1) + theme(axis.text.x = element_text(angle = 90))

# To add labels to tiles
#geom_text(aes(label = round(mDelay, 1)))
``` 

```{r echo=FALSE, eval=F}
# get data for top 5 airports first
top_airlines = delays[(delays$airlineID %in% top_5_airlines$airline), ]
agg = aggregate(mDelay ~ airlineID + airportID, data=top_airlines, FUN=mean)
hm.palette <- colorRampPalette(rev(brewer.pal(9, 'Spectral')), space='Lab') 
ggplot(agg[1:80, ], aes(x=airportID, y=airlineID)) + geom_tile(aes(fill=mDelay), color="white") + scale_fill_gradientn(colours = hm.palette(1000)) + labs(y = "Airlines",x="Airport",col = "Delay in Minutes", title="Mean delays from all airlines to top 5 airports") + geom_text(aes(label = round(mDelay, 1))) + theme_light()  + theme(axis.text.x = element_text(angle = 90))
``` 


```{r eval=FALSE, echo=FALSE}
most_active_airports = read.table(paste(RESOURCE_DIR, "most-active-airport/part-r-00000", sep=""))
most_active_airlines = read.table(paste(RESOURCE_DIR, "most-active-airlines/part-r-00000", sep=""))

names(most_active_airlines) = c("activity", "airlineID")
names(most_active_airports) = c("activity", "airportID")

top_5_dest = most_active_airports[1, ]
top_5_airlines = most_active_airlines[1:5, ]

airline_id = read.csv("resources/Airline_id.csv", header=T)
filtered = filter(airline_delay, airline_delay$airportID %in% c(top_5_dest$airportID))
agg = aggregate(mDelay ~ airlineID + airportID, data=filtered, FUN=sum)
dest_graph = graph.data.frame(agg, directed=T)
V(dest_graph)$color<-ifelse(V(dest_graph)$name %in% top_5_dest$airportID, topo.colors(12)[3], ifelse(V(dest_graph)$name %in% top_5_airlines$airlineID, 'red', topo.colors(12)[12]))
E(dest_graph)$color = topo.colors(12)[8]
par(0, 0, 1, 0)
V(dest_graph)$size<-ifelse(V(dest_graph)$name %in% top_5_dest, 10, E(dest_graph)$mDelay / 2)
plot(dest_graph, layout=layout.kamada.kawai,
vertex.label.dist=2,
vertex.label.color='black',
vertex.label.font = 0.5,
vertex.label=V(dest_graph)$name,
main="Airline delays to Destination (in blue)")

top_5_dest = most_active_airports[2, ]
top_5_airlines = most_active_airlines[1:5, ]

airline_id = read.csv("resources/Airline_id.csv", header=T)
filtered = filter(airline_delay, airline_delay$airportID %in% c(top_5_dest$airportID))
agg = aggregate(mDelay ~ airlineID + airportID, data=filtered, FUN=sum)
dest_graph = graph.data.frame(agg, directed=T)
V(dest_graph)$size<-ifelse(V(dest_graph)$name %in% top_5_dest, 10, E(dest_graph)$mDelay / 2)
V(dest_graph)$color<-ifelse(V(dest_graph)$name %in% top_5_dest$airportID, topo.colors(12)[3], ifelse(V(dest_graph)$name %in% top_5_airlines$airlineID, 'red', topo.colors(12)[12]))
E(dest_graph)$color = topo.colors(12)[8]
par(0, 0, 1, 0)
plot(dest_graph, layout=layout.kamada.kawai,
vertex.label.dist=2,
vertex.label.color='black',
vertex.label.font = 0.2,
vertex.label=V(dest_graph)$name,
main="Airline delays to Destination (in blue)")
```

As we can see in the figure above, airlineID 19790 Delta Airlines has more delays in flights when going to Chicago Airport (13930). Moreover, Delta Airlines is also one of the most active top 5 airlines.

#### Mean delays for top 5 destinations across months

Mean delays for top 5 destinations are displayed across months for all years in the graph below.

Here, we can see that airport ID `13930` (chicago airport), has more delays lying above 0.3 mean delay. This airport also happens to be the most active airport in the dataset.

```{r message=FALSE, eval=FALSE, echo=FALSE}
top_5_dest = most_active_airports[1:5, ]
plot_data = airport_delay %>%
  filter(airportID %in% top_5_dest$airportID) %>%
    group_by(month,airportID)

b1<-ggplot(plot_data, aes(month, mDelay)) + xlim(1, 12) + ylim(0.1, 0.5) +
  geom_jitter(alpha=I(1/4), aes(col = factor(plot_data$airportID)))
  labs(x="Month of year",y="Mean Delay",title="Flight Delays to Top 5 Destinations", col="Airport IDs")
b1
```



#### Mean delays for destinations across years

The graph below shows mean delows for destinations across years. Interestingly, the delays for top 5 most active airports have increased after the year 2006. Moreover, in 2015 there they mean delay has increased significantly for `13930` which seems to have the highest mean delay in all other years.

Interestingly, the two datapoints for year 2013 are sort of the outliers. This could be because of sequestration-related furloughs being in effect during that year in Chicago.

```{r message=FALSE, eval=FALSE, echo=FALSE}
top_5_dest = most_active_airports[1:5, ]
plot_data = airport_delay %>%
  filter(airportID %in% top_5_dest$airportID) %>%
    group_by(year,airportID)

b1<-ggplot(plot_data, aes(year, mDelay)) + ylim(0.1, 0.5) +
  geom_jitter(alpha=I(1/4), aes(col = factor(plot_data$airportID))) +
  scale_x_continuous(breaks=seq(2006, 2015)) +
  labs(x="Year",y="Mean Delay",title="Flight Delays to Top 5 Destinations")
b1
```

